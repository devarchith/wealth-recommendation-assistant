##############################################################################
# Nginx — WealthAdvisor AI On-Premise TLS Configuration
# ======================================================
# TLS 1.3 only | HSTS | OCSP Stapling | CSP | Rate limiting
# Replace ${DOMAIN} with your internal hostname before deployment.
##############################################################################

user  nginx;
worker_processes auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # ── Logging ─────────────────────────────────────────────────────────────
    log_format json_access escape=json
        '{"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"method":"$request_method",'
        '"uri":"$uri",'
        '"status":$status,'
        '"bytes":$body_bytes_sent,'
        '"referer":"$http_referer",'
        '"ua":"$http_user_agent",'
        '"req_id":"$request_id",'
        '"ssl_protocol":"$ssl_protocol",'
        '"upstream_time":"$upstream_response_time",'
        '"request_time":"$request_time"}';

    access_log /var/log/wealthai/access.log json_access buffer=64k flush=5s;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout 65;
    server_tokens   off;
    gzip            on;
    gzip_types      text/plain application/json application/javascript text/css;

    # ── Rate limiting ────────────────────────────────────────────────────────
    limit_req_zone  $binary_remote_addr zone=api_limit:10m rate=60r/m;
    limit_req_zone  $binary_remote_addr zone=auth_limit:10m rate=10r/m;
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    # ── HTTP → HTTPS redirect ────────────────────────────────────────────────
    server {
        listen 80;
        server_name _;
        return 301 https://$host$request_uri;
    }

    # ── HTTPS server ─────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name wealthai.internal;   # change to your internal FQDN

        # ── TLS ──────────────────────────────────────────────────────────────
        ssl_certificate     /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;
        ssl_protocols       TLSv1.3;
        ssl_prefer_server_ciphers off;
        ssl_session_cache   shared:SSL:10m;
        ssl_session_timeout 1d;
        ssl_session_tickets off;

        # OCSP stapling (requires internet access for CA; disable for air-gapped)
        ssl_stapling        on;
        ssl_stapling_verify on;
        ssl_trusted_certificate /etc/nginx/certs/ca-chain.crt;

        # ── Security headers ─────────────────────────────────────────────────
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
        add_header Content-Security-Policy
            "default-src 'self'; "
            "script-src 'self' 'nonce-$request_id'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data:; "
            "connect-src 'self'; "
            "frame-ancestors 'none';" always;
        add_header X-Request-ID $request_id always;

        limit_conn conn_limit 20;

        # ── Frontend ─────────────────────────────────────────────────────────
        location / {
            proxy_pass         http://frontend:3000;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_set_header   X-Request-ID $request_id;
            proxy_read_timeout 60s;
            proxy_buffering    off;

            # Cache Next.js static assets
            location ~* \.(js|css|png|jpg|svg|ico|woff2?)$ {
                proxy_pass http://frontend:3000;
                expires 30d;
                add_header Cache-Control "public, immutable";
            }
        }

        # ── API Gateway ───────────────────────────────────────────────────────
        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;

            proxy_pass         http://api-gateway:3001;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_set_header   X-Request-ID $request_id;
            proxy_read_timeout 120s;
            proxy_buffering    off;

            # SSE (streaming chat responses)
            location /api/chat {
                proxy_pass              http://api-gateway:3001;
                proxy_set_header        Connection '';
                proxy_http_version      1.1;
                chunked_transfer_encoding on;
                proxy_read_timeout      300s;
            }
        }

        # ── Auth endpoints — stricter rate limit ──────────────────────────────
        location /api/auth/ {
            limit_req zone=auth_limit burst=5 nodelay;
            proxy_pass       http://api-gateway:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ── Razorpay webhook — no rate limit (Razorpay IPs) ──────────────────
        location /api/billing/webhook {
            proxy_pass       http://api-gateway:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # ── Health check — no auth, no rate limit ─────────────────────────────
        location /api/health {
            proxy_pass http://api-gateway:3001;
            access_log off;
        }

        # ── Block sensitive paths ─────────────────────────────────────────────
        location ~ /\.(git|env|htpasswd) {
            deny all;
            return 404;
        }
    }
}
